# SSH keys
vim /root/.ssh/authorized_keys2

# Hostname
vim /etc/hostname
hostname -F /etc/hostname

# Additional devices
mknod -m 660 /dev/md2 b 9 2
mknod -m 660 /dev/sda3 b 8 3
mknod -m 660 /dev/sdb3 b 8 19

chown root:disk /dev/md2 /dev/sda3 /dev/sdb3

# Create RAID1
cfdisk /dev/sda
cfdisk /dev/sdb
reboot
mdadm --create /dev/md2 --level=1 --raid-devices=2 /dev/sd[ab]3
echo 'DEVICE /dev/sd*[0-9]' > /etc/mdadm/mdadm.conf
mdadm --detail --scan >> /etc/mdadm/mdadm.conf

# LVM
pvcreate /dev/md2
vgcreate lxc /dev/md2
lvcreate -L50G -n lxc lxc
mkfs.ext4 /dev/mapper/lxc-lxc

# LXC repo
mkdir -m 711 /lxc
mount /dev/mapper/lxc-lxc /lxc
aptitude update
aptitude install git
git clone git@github.com:rootnode/lxc.git /lxc/repo

# Aptitude
cp /lxc/repo/config/web/system/etc/apt/sources.list /etc/apt/sources.list
aptitude update
aptitude upgrade
cat /lxc/repo/config/web/system/dpkg-selections | dpkg --set-selections
apt-get dselect-upgrade

# Time zone
cp /lxc/repo/config/web/system/etc/timezone /etc/timezone
dpkg-reconfigure tzdata

# Kernel
cp /lxc/repo/config/web/system/etc/default/grub /etc/default/grub
dpkg -i /lxc/repo/kernel/linux-image-2.6.32.59-grsec-lxc-rootnode-is-sexy-ipv6-64_3_amd64.deb
grub-set-default 1
reboot

# Network
cp /lxc/repo/config/web/system/etc/network/interfaces /etc/network/interfaces
vim /etc/network/interfaces
/etc/init.d/networking restart

# Fstab
cp /lxc/repo/config/web/system/etc/fstab /etc/fstab
mount -o remount /
mount -o remount /lxc


# Cgroups
mkdir /cgroup
mount /cgroup

# Sysctl
cp -prv /lxc/repo/config/web/system/etc/sysctl.d /etc/
sysctl -p
sysctl -p /etc/sysctl.d/*.conf

# Repo binaries
ln -s /lxc/repo/rsnapshot/remote/lvm-snapshot.pl /usr/local/sbin/lvm-snapshot
ln -s /lxc/repo/lxc-manager/lxc-manager.pl /usr/local/sbin/lxc
ln -s /lxc/repo/adduser/lxc-add.pl /usr/local/sbin/lxc-add
ln -s /lxc/repo/rsnapshot/remote/restrict-ssh.sh /usr/local/sbin/restrict-ssh

# SSH key
ssh-keygen -t rsa -b 2048

# User template
rsync -av /lxc/template/*.tar root@system.web3.rootnode.net:/lxc/template/
for i in *.tar ; do echo $i ; tar xf $i ; done

# System containers
lxc create proxy 5 system

